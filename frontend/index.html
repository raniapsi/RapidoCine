<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidoCine - Votre Watchlist de Films</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .auth-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }

        .auth-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .auth-form input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .user-info {
            color: #667eea;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-btn {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .search-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .search-form {
            display: flex;
            gap: 10px;
        }

        .search-form input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 400px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .movie-card {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .movie-poster {
            width: 100%;
            height: 400px;
            object-fit: cover;
            background: #ddd;
        }

        .movie-info {
            padding: 15px;
        }

        .movie-title {
            color: #667eea;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .movie-year {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .movie-genres {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .rating-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .stars {
            display: flex;
            gap: 5px;
        }

        .star {
            cursor: pointer;
            font-size: 1.5rem;
            color: #ddd;
            transition: color 0.2s;
        }

        .star.filled {
            color: #ffd700;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.85rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .status-TO_WATCH { background: #3498db; color: white; }
        .status-WATCHING { background: #f39c12; color: white; }
        .status-WATCHED { background: #2ecc71; color: white; }

        .comment-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .comment {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: bold;
            color: #667eea;
            font-size: 0.9rem;
        }

        .comment-content {
            color: #666;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .add-comment {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-comment textarea {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            resize: vertical;
            min-height: 60px;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .filter-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            color: #333;
        }

        .filter-btn:hover {
            background: #e8e8e8;
            border-color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ RapidoCine</h1>
            <p>D√©couvrez et g√©rez votre collection de films</p>
        </header>

        <div class="auth-section" id="auth-section">
            <div id="login-form" class="auth-form">
                <input type="text" id="login-username" placeholder="Nom d'utilisateur">
                <input type="password" id="login-password" placeholder="Mot de passe">
                <button class="btn" onclick="login()">Connexion</button>
            </div>
            <div id="user-info" style="display:none;">
                <span class="user-info">Connect√©: <span id="current-user"></span></span>
                <button class="btn btn-danger btn-small" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div id="message-area"></div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('movies')">üé• Films</button>
            <button class="tab-btn" onclick="switchTab('watchlist')">üìã Ma Watchlist</button>
            <button class="tab-btn" onclick="switchTab('ratings')">‚≠ê Mes Notes</button>
        </div>

        <div class="search-section" id="search-section">
            <div class="search-form">
                <input type="text" id="search-input" placeholder="Rechercher un film...">
                <button class="btn" onclick="searchMovies()">Rechercher</button>
                <button class="btn" onclick="loadMovies()">Tous les films</button>
            </div>
        </div>

        <div class="filter-section" id="filter-section" style="display: none;">
            <h3>Filtrer par genre</h3>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterByGenre('all')">Tous</button>
                <button class="filter-btn" onclick="filterByGenre('Action')">Action</button>
                <button class="filter-btn" onclick="filterByGenre('Comedy')">Com√©die</button>
                <button class="filter-btn" onclick="filterByGenre('Drama')">Drame</button>
                <button class="filter-btn" onclick="filterByGenre('Thriller')">Thriller</button>
                <button class="filter-btn" onclick="filterByGenre('Horror')">Horreur</button>
                <button class="filter-btn" onclick="filterByGenre('Romance')">Romance</button>
                <button class="filter-btn" onclick="filterByGenre('Sci-Fi')">Science-Fiction</button>
                <button class="filter-btn" onclick="filterByGenre('Adventure')">Aventure</button>
                <button class="filter-btn" onclick="filterByGenre('Animation')">Animation</button>
                <button class="filter-btn" onclick="filterByGenre('Crime')">Crime</button>
                <button class="filter-btn" onclick="filterByGenre('Fantasy')">Fantasy</button>
            </div>
        </div>

        <div class="results-section">
            <h2 id="results-title">Films disponibles</h2>
            <div id="results" class="results-grid"></div>
        </div>
    </div>

    <script>
        // Mode d√©veloppement : API directe sur le port 8000
        const API_URL = 'http://localhost:8000/api';
        let currentUser = null;
        let currentTab = 'movies';
        let allMovies = [];
        let currentGenreFilter = 'all';

        // Charger les films au d√©marrage
        loadMovies();

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data;
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('user-info').style.display = 'flex';
                    document.getElementById('current-user').textContent = data.username;
                    showMessage('Connexion r√©ussie!', 'success');
                    loadMovies();
                } else {
                    showMessage('Identifiants incorrects', 'error');
                }
            } catch (error) {
                showMessage('Erreur de connexion', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-form').style.display = 'flex';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            showMessage('D√©connect√©', 'success');
            loadMovies();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'movies') {
                document.getElementById('search-section').style.display = 'block';
                document.getElementById('filter-section').style.display = 'block';
                loadMovies();
            } else if (tab === 'watchlist') {
                document.getElementById('search-section').style.display = 'none';
                document.getElementById('filter-section').style.display = 'none';
                loadWatchlist();
            } else if (tab === 'ratings') {
                document.getElementById('search-section').style.display = 'none';
                document.getElementById('filter-section').style.display = 'none';
                loadUserRatings();
            }
        }

        async function loadMovies() {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/movies/`);
                allMovies = await response.json();
                applyGenreFilter();
            } catch (error) {
                showMessage('Erreur de chargement des films', 'error');
            }
        }

        function filterByGenre(genre) {
            currentGenreFilter = genre;
            
            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyGenreFilter();
        }

        function applyGenreFilter() {
            let filteredMovies = allMovies;
            
            if (currentGenreFilter !== 'all') {
                filteredMovies = allMovies.filter(movie => {
                    if (!movie.genre) return false;
                    const genres = movie.genre.split(',').map(g => g.trim());
                    return genres.some(g => g.toLowerCase().includes(currentGenreFilter.toLowerCase()));
                });
            }
            
            const title = currentGenreFilter === 'all' 
                ? 'Films disponibles' 
                : `Films - ${currentGenreFilter}`;
            displayMovies(filteredMovies, title);
        }

        async function searchMovies() {
            const query = document.getElementById('search-input').value;
            if (!query) {
                loadMovies();
                return;
            }
            showLoading();
            try {
                const response = await fetch(`${API_URL}/movies/search?title=${encodeURIComponent(query)}`);
                const movies = await response.json();
                displayMovies(movies, `R√©sultats pour "${query}"`);
            } catch (error) {
                showMessage('Erreur de recherche', 'error');
            }
        }

        async function loadWatchlist() {
            if (!currentUser) {
                showMessage('Veuillez vous connecter', 'error');
                return;
            }
            showLoading();
            try {
                const response = await fetch(`${API_URL}/watchlist/user/${currentUser.user_id}`);
                const watchlist = await response.json();
                
                const moviePromises = watchlist.map(item => 
                    fetch(`${API_URL}/movies/${item.movie_id}`).then(r => r.json())
                );
                const movies = await Promise.all(moviePromises);
                
                movies.forEach((movie, i) => {
                    movie.watchlist_status = watchlist[i].status;
                    movie.watchlist_id = watchlist[i].id;
                });
                
                displayMovies(movies, 'Ma Watchlist');
            } catch (error) {
                showMessage('Erreur de chargement de la watchlist', 'error');
            }
        }

        async function loadUserRatings() {
            if (!currentUser) {
                showMessage('Veuillez vous connecter', 'error');
                return;
            }
            showLoading();
            try {
                const response = await fetch(`${API_URL}/ratings/user/${currentUser.user_id}`);
                let ratings = await response.json();

                // D√©doublonner
                const byMovie = new Map();
                ratings.forEach(r => {
                    const prev = byMovie.get(r.movie_id);
                    if (!prev) { 
                        byMovie.set(r.movie_id, r); 
                        return; 
                    }
                    const newer = (r.updated_at && prev.updated_at) 
                        ? (r.updated_at > prev.updated_at) 
                        : ((r.id || 0) > (prev.id || 0));
                    if (newer) byMovie.set(r.movie_id, r);
                });
                ratings = Array.from(byMovie.values());

                // R√©cup√©rer les films
                const movies = await Promise.all(
                    ratings.map(r => fetch(`${API_URL}/movies/${r.movie_id}`).then(resp => resp.json()))
                );

                // Associer notes et TRIER STRICTEMENT
                const moviesWithRating = movies.map((m, i) => ({ 
                    ...m, 
                    user_rating: parseInt(ratings[i].score) 
                }));
                
                // Tri d√©croissant : 5‚òÖ ‚Üí 1‚òÖ
                moviesWithRating.sort((a, b) => {
                    const scoreA = parseInt(a.user_rating) || 0;
                    const scoreB = parseInt(b.user_rating) || 0;
                    if (scoreB !== scoreA) return scoreB - scoreA;  // DESC
                    return (a.title || '').localeCompare(b.title || '');
                });

                displayMovies(moviesWithRating, 'Films que j\'ai not√©s');
            } catch (error) {
                showMessage('Erreur de chargement des notes', 'error');
            }
        }

        async function displayMovies(movies, title) {
            document.getElementById('results-title').textContent = `${title} (${movies.length})`;
            
            const html = await Promise.all(movies.map(async movie => {
                const avgRating = await getAverageRating(movie.id);
                const comments = await getComments(movie.id);
                
                return `
                    <div class="movie-card">
                        <img src="${movie.poster_url || 'https://via.placeholder.com/300x450?text=No+Poster'}" 
                             alt="${movie.title}" class="movie-poster" onerror="this.src='https://via.placeholder.com/300x450?text=No+Poster'">
                        <div class="movie-info">
                            <div class="movie-title">${movie.title}</div>
                            <div class="movie-year">üìÖ ${movie.year}</div>
                            <div class="movie-genres">${movie.genres || 'N/A'}</div>
                            <div style="font-size:0.85rem;color:#888;margin-bottom:10px;">
                                IMDb: ${movie.imdb_id} | ‚≠ê ${avgRating || 'N/A'}
                            </div>
                            ${movie.watchlist_status ? `<span class="status-badge status-${movie.watchlist_status}">${movie.watchlist_status}</span>` : ''}
                            
                            ${currentUser ? `
                                <div class="rating-section">
                                    <span style="font-size:0.9rem;">Noter:</span>
                                    <div class="stars" data-movie-id="${movie.id}">
                                        ${[1,2,3,4,5].map(score => `
                                            <span class="star ${movie.user_rating >= score ? 'filled' : ''}" 
                                                  onclick="rateMovie(${movie.id}, ${score})">‚òÖ</span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="actions">
                                    <button class="btn btn-small" onclick="addToWatchlist(${movie.id}, 'TO_WATCH')">üìã √Ä voir</button>
                                    <button class="btn btn-small" onclick="addToWatchlist(${movie.id}, 'WATCHED')">‚úì Vu</button>
                                </div>
                                
                                <div class="comment-section">
                                    <div>${comments.slice(0, 2).map(c => `
                                        <div class="comment">
                                            <div class="comment-author">üë§ User ${c.user_id}</div>
                                            <div class="comment-content">${c.content}</div>
                                        </div>
                                    `).join('')}</div>
                                    <div class="add-comment">
                                        <textarea id="comment-${movie.id}" placeholder="Ajouter un commentaire..."></textarea>
                                        <button class="btn btn-small" onclick="addComment(${movie.id})">Envoyer</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }));
            
            document.getElementById('results').innerHTML = html.join('') || '<p class="loading">Aucun film trouv√©</p>';
        }

        async function getAverageRating(movieId) {
            try {
                const response = await fetch(`${API_URL}/ratings/movie/${movieId}/average`);
                const data = await response.json();
                return data.average ? data.average.toFixed(1) : null;
            } catch {
                return null;
            }
        }

        async function getComments(movieId) {
            try {
                const response = await fetch(`${API_URL}/comments/movie/${movieId}`);
                return await response.json();
            } catch {
                return [];
            }
        }

        async function rateMovie(movieId, score) {
            if (!currentUser) {
                showMessage('Veuillez vous connecter', 'error');
                return;
            }

            try {
                await fetch(`${API_URL}/ratings/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.user_id,
                        movie_id: movieId,
                        score: score
                    })
                });
                showMessage('Note ajout√©e!', 'success');
                
                const stars = document.querySelectorAll(`[data-movie-id="${movieId}"] .star`);
                stars.forEach((star, index) => {
                    if (index < score) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
            } catch (error) {
                showMessage('Erreur lors de l\'ajout de la note', 'error');
            }
        }

        async function addToWatchlist(movieId, status) {
            if (!currentUser) {
                showMessage('Veuillez vous connecter', 'error');
                return;
            }

            try {
                await fetch(`${API_URL}/watchlist/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.user_id,
                        movie_id: movieId,
                        status: status
                    })
                });
                showMessage(`Film ajout√© √† la watchlist (${status})`, 'success');
            } catch (error) {
                showMessage('Erreur lors de l\'ajout √† la watchlist', 'error');
            }
        }

        async function addComment(movieId) {
            if (!currentUser) {
                showMessage('Veuillez vous connecter', 'error');
                return;
            }

            const content = document.getElementById(`comment-${movieId}`).value;
            if (!content) return;

            try {
                await fetch(`${API_URL}/comments/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.user_id,
                        movie_id: movieId,
                        content: content
                    })
                });
                document.getElementById(`comment-${movieId}`).value = '';
                showMessage('Commentaire ajout√©!', 'success');
                
                if (currentTab === 'movies') loadMovies();
                else if (currentTab === 'watchlist') loadWatchlist();
                else loadUserRatings();
            } catch (error) {
                showMessage('Erreur lors de l\'ajout du commentaire', 'error');
            }
        }

        function showLoading() {
            document.getElementById('results').innerHTML = '<p class="loading">Chargement...</p>';
        }

        function showMessage(message, type) {
            const msgArea = document.getElementById('message-area');
            msgArea.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => msgArea.innerHTML = '', 3000);
        }
    </script>
</body>
</html>
